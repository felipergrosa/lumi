<div class="app-main__inner">

    <div id="cadastro_clientes" style="display:none">
    </div>

    <div class="mb-3 card" id="cadastro_pedidos_edit">
        <div class="card-header-tab card-header">
            <div class="card-header-title font-size-lg text-capitalize font-weight-normal" style="display:block;">
                <i class="header-icon lnr-charts icon-gradient bg-happy-green"> </i>
                <span>Cadastro de Pedido</span>
            </div>
        </div>
        <div class="card-body">
            <form onsubmit="return false;" id="cadastro_pedidos_edit_form" name="cadastro_pedidos_edit_form">
                <span id="cadastro_pedidos_top_form">
                <input type="hidden" name="action_for_form" id="action_for_form" value="" />
                <div class="form-group row">

                    <div class="col-md-8 col-xs-12">
                        <label for="cadastro_pedidos_edit_form_cpfcnpj">Busca (Nome, Razao Social, CNPJ)</label>
                        <input type="text" class="form-control" id="cadastro_pedidos_edit_form_cpfcnpj" name="cadastro_pedidos_edit_form_cpfcnpj" onblur="BuscaCPFCNPJ(this.value);"/>
                    </div>

                    <div class="col-md-4 col-xs-12">
                        <label for="cadastro_pedidos_edit_form_empresa">Empresa Representada</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_empresa" name="cadastro_pedidos_edit_form_empresa">
                        </select>
                    </div>

                </div>

                <button type="submit" class="btn btn-primary" onclick="CadastroPedidosContinuar();">Continuar</button>
                </span>
                <span id="cadastro_pedidos_middle_form">
                <div class="form-group row">
                    <div class="col-md-3 col-xs-4">
                        <input type="hidden" class="form-control" id="cadastro_pedidos_edit_form_id" name="cadastro_pedidos_edit_form_id" />
                        <label for="cadastro_pedidos_edit_form_empresa_nome">Empresa</label>
                        <input type="text" class="form-control" id="cadastro_pedidos_edit_form_empresa_nome" name="cadastro_pedidos_edit_form_empresa_nome" readonly/>
                    </div>
                    <div class="col-md-4 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_cliente_nome">Cliente</label>
                        <input type="text" class="form-control" id="cadastro_pedidos_edit_form_cliente_nome" name="cadastro_pedidos_edit_form_cliente_nome" readonly/>
                    </div>
                    <div class="col-md-1 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_prioridade">Prioridade</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_prioridade" name="cadastro_pedidos_edit_form_prioridade">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_frete">Frete</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_frete" name="cadastro_pedidos_edit_form_frete">
                            <option value="FOB">FOB</option>
                            <option value="CIF">CIF</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_num_pedido_representante">N° pedido repres.</label>
                        <input type="number" class="form-control" id="cadastro_pedidos_edit_form_num_pedido_representante" name="cadastro_pedidos_edit_form_num_pedido_representante" />
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_data_pedido">Data Pedido</label>
                        <input type="date" class="form-control" id="cadastro_pedidos_edit_form_data_pedido" name="cadastro_pedidos_edit_form_data_pedido" />
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_data_previsao_faturamento">Prev Fatura</label>
                        <input type="date" class="form-control" id="cadastro_pedidos_edit_form_data_previsao_faturamento" name="cadastro_pedidos_edit_form_data_previsao_faturamento" />
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_num_pedido_compra">N° ped comp</label>
                        <input type="number" class="form-control" id="cadastro_pedidos_edit_form_num_pedido_compra" name="cadastro_pedidos_edit_form_num_pedido_compra" />
                    </div>
                    <div class="col-md-3 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_tabela_preco">Tabela Preço</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_tabela_preco" name="cadastro_pedidos_edit_form_tabela_preco">
                            <option value="1">1</option>
                        </select>
                    </div>
                    <div class="col-md-3 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_transportadora">Transportadora</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_transportadora" name="cadastro_pedidos_edit_form_transportadora">
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-md-12"> <span class=" font-size-lg">Descontos</span> </div>

                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_desconto_padrao">Padrao</label>
                        <input type="text" class="form-control" id="cadastro_pedidos_edit_form_desconto_padrao" placeholder="0,00" name="cadastro_pedidos_edit_form_desconto_padrao" onkeyup="percent(this);" maxlength="6"/>
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_desconto_adic1">Adic 1</label>
                        <input class="form-control" id="cadastro_pedidos_edit_form_desconto_adic1" placeholder="0,00" name="cadastro_pedidos_edit_form_desconto_adic1" onkeyup="percent(this);" maxlength="6"/>
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_desconto_adic2">Adic 2</label>
                        <input class="form-control" id="cadastro_pedidos_edit_form_desconto_adic2" placeholder="0,00" name="cadastro_pedidos_edit_form_desconto_adic2" onkeyup="percent(this);" maxlength="6"/>
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_desconto_adic3">Adic 3</label>
                        <input  step="any" class="form-control" id="cadastro_pedidos_edit_form_desconto_adic3" placeholder="0,00" name="cadastro_pedidos_edit_form_desconto_adic3" onkeyup="percent(this);" maxlength="6"/>
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_desconto_part_com">Part.com.</label>
                        <input  class="form-control" id="cadastro_pedidos_edit_form_desconto_part_com" name="cadastro_pedidos_edit_form_desconto_part_com" onkeyup="percent(this);" maxlength="6"/>
                    </div>
                    <div class="col-md-6 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_natureza_operacao">Natureza de operação</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_natureza_operacao" name="cadastro_pedidos_edit_form_natureza_operacao">
                        </select>
                    </div>
                    <div class="col-md-6 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_observacao">Observação</label>
                        <textarea class="form-control" id="cadastro_pedidos_edit_form_observacao" name="cadastro_pedidos_edit_form_observacao"></textarea>
                    </div>

                </div>


                <button type="submit" class="btn btn-primary" onclick="CadastroPedidosIrParaProdutos();">Continuar</button>
                </span>
                <span id="cadastro_pedidos_produtos_form">
                    <span id="" class="produtos_dinamico" style="">
                        <!-- <div class="form-group row produto">
                            <div class="col-md-2 col-xs-4">
                                <label for="cadastro_pedidos_edit_form_produto_id">id</label>
                                <input type="text" class="form-control" id="cadastro_pedidos_edit_form_produto_id" name="cadastro_pedidos_edit_form_produto_id"/>
                            </div>
                            <div class="col-md-4 col-xs-4">
                                <label for="cadastro_pedidos_edit_form_produto_nome">produto</label>
                                <input type="text" class="form-control" id="cadastro_pedidos_edit_form_produto_nome" name="cadastro_pedidos_edit_form_produto_nome"/>
                            </div>
                            <div class="col-md-2 col-xs-2">
                                <label for="cadastro_pedidos_edit_form_produto_qt">qt</label>
                                <input type="number" class="form-control" id="cadastro_pedidos_edit_form_produto_qt" name="cadastro_pedidos_edit_form_produto_qt"/>

                            </div>
                            <div class="col-md-2 col-xs-2">
                                <label for="cadastro_pedidos_edit_form_produto_preco">preço</label>
                                <input type="number" step="any" class="form-control" id="cadastro_pedidos_edit_form_produto_preco" name="cadastro_pedidos_edit_form_produto_preco" readonly/>
                            </div>
                            <div class="col-md-2 col-xs-2">
                                <label for="cadastro_pedidos_edit_form_produto_preco_sub">subtotal</label>
                                <input type="number" step="any" class="form-control" id="cadastro_pedidos_edit_form_produto_preco_sub" name="cadastro_pedidos_edit_form_produto_preco_sub" readonly/>
                            </div>
                        </div> -->
                    </span>
                    <div class="form-group row">
                        <div class="col-xs-3 col-md-3">

                            <!-- <label>-</label>
                            <btn class="btn btn-success btn-block" id="Finaliza_button" onclick="javascript: CadastroPedidosSalvar();">Finalizar Pedido</btn> -->
                        </div>
                        <div class="col-xs-3 col-md-3">
                        </div>
                        <div class="col-xs-3 col-md-3">
                            <label for="cadastro_pedidos_edit_form_cond_pagto">Cond. Pagto</label>
                            <select class="form-control" id="cadastro_pedidos_edit_form_cond_pagto" name="cadastro_pedidos_edit_form_cond_pagto">
                            </select>
                        </div>
                        <div class="col-xs-3 col-md-3">
                            <label>Total</label>
                            <input type="text" class="form-control" id="vendas_nova_venda_total" name="vendas_nova_venda_total" value="0"/>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-xs-12 col-md-4">

                            <label>-</label>
                            <btn class="btn btn-warning btn-block" onclick="javascript: CadastroPedidosImprimir();">Imprimir Pedido</btn>
                        </div>
                        <div class="col-xs-12 col-md-4">

                            <label>-</label>
                            <btn class="btn btn-success btn-block" onclick="javascript: CadastroPedidosTermo();">Termo Responsabilidade</btn>
                        </div>

                        <div class="col-xs-12 col-md-4">

                            <label>-</label>
                            <btn class="btn btn-danger btn-block" id="Finaliza_button" onclick="javascript: CadastroPedidosSalvar();">Finalizar Pedido</btn>
                        </div>
                    </div>
                </span>
            </form>
        </div>
    </div>

</div>


<script type="text/javascript">
    t = '';
    $(document).ready(function(){
        $.jMaskGlobals.watchDataMask = true;
        // window.onerror = function(){
        //    return true;
        // }
        // MascaraCpfCnpj('#cadastro_pedidos_edit_form_cpfcnpj');

        $('#cadastro_pedidos_edit_form_data_pedido').val(new Date().toDateInputValue());
        $('#cadastro_pedidos_edit_form_data_previsao_faturamento').val(new Date().toDateInputValue());
        // PopularEmpresas('#cadastro_pedidos_edit_form_empresa');
        console.log('populando');
        $('.produtos_dinamico').load('content/pages/movimentacoes/pedidos/PedidosSistema/produtos_dinamico.php');



    });




    function BuscaProdutoGatilho(element, busca, alvo = false){
        clearTimeout(t);
        t = setTimeout(function(){
            BuscaCombo(element, busca, alvo);
        }, 500);
    }
    function BuscaProduto(busca){
        var tabela_preco = $('#cadastro_pedidos_edit_form_tabela_preco');
        if(busca != "" && tabela_preco != ""){
            var action = "busca_produtos";
            $.ajax({
                type: 'POST',
                url: 'dist/php/controllers/produtos.api.php',
                dataType: 'json',
                async: 'false',
                data: {'action': action, 'busca':busca, 'tabela':tabela_preco},
                success: function (data)
                {
                    console.log(data);



                }
            });
        }

    }
    function Log(val){
        console.log(val);
    }
    function GetUserList(){
        $('.cadastro_pedidos_lista').html('');
        // console.log('getting');
        $.ajax({
            type: 'POST',
            url: 'content/pages/movimentacoes/pedidos/PedidosSistema/post.php',
            data: {'action':'GetUserList'},
            dataType: 'json',
            async: false,
            success: function (UserList)
            {
                $(UserList).each(function(k,v){
                    // console.log(UserList);

                    $('.cadastro_pedidos_lista').append('<tr onclick="GetUserInfoEdit(\'' + v.id + '\', \'editar\')"><td>' + v.nome + '</td><td class="campo_cpfcnpj_lista">' + v.cpfcnpj + '</td><td>' + v.endereco_cidade + '</td><td>' + v.endereco_estado + '</td></tr>');
                });
                MascaraCpfCnpjManualTexto('.campo_cpfcnpj_lista');
            }
        });
    }
    function GetUserInfoEdit(id, action){


    }
    function CadastroPedidosSalvar() {

        var dados = $('#cadastro_pedidos_edit_form').serializeArray();
        var empresas = $('#cadastro_pedidos_edit_form_empresa').val();
        var produtos = $('#cadastro_pedidos_produtos_form').serializeArray();
        var action = 'novo';

        // console.log(produtos);
        $.ajax({
            type: 'POST',
            url: 'content/pages/movimentacoes/pedidos/PedidosSistema/post.php',
            data: {'dados': dados, 'action': action, 'empresas':empresas, 'produtos':produtos},
            success: function (data)
            {
                console.log(data);
                if (data == 0) {
                    toastr.success('Cadastro Realizado');
                    CarregaPagina('content/pages/movimentacoes/pedidos/PedidosSistema/cadastro_pedidos.html')

                } else {
                    toastr.error('Erro: ' + data);
                    $('#cadastro_pedidos_middle_form').show();

                }
            }
        });

    }
    function MascaraCpfCnpj(campo){
        $(campo).keydown(function(event){
            // console.log(event.originalEvent.code);
            if(event.originalEvent.code != 'Tab' && event.originalEvent.code != 'Enter' && event.originalEvent.code != 'NumpadEnter'){
                try {
                    $(campo).unmask();
                } catch (e) {}

                var tamanho = $(campo).val().length;

                if(tamanho < 11){
                    $(campo).mask("999.999.999-99", {reverse: true, maxlength:false, recursive:true});
                } else {
                    $(campo).mask("99.999.999/9999-99", {reverse: true, maxlength:false, recursive:true});
                }

                // ajustando foco
                var elem = this;
                setTimeout(function(){
                    // mudo a posição do seletor
                    elem.selectionStart = elem.selectionEnd = 10000;
                }, 0);
                // reaplico o valor para mudar o foco
                var currentValue = $(this).val();
                $(this).val('');
                $(this).val(currentValue);
            }
        });

    }
    function MascaraCpfCnpjManualTexto(campo){
        try {
            $(campo).unmask();
        } catch (e) {}

        $(campo).each(function(k,v){
            var tamanho = $(v).text().length;
            if(tamanho <= 11){
                $(v).mask("999.999.999-99");
            } else {
                $(v).mask("99.999.999/9999-99");
            }
        });

        var tamanho = $(campo).text().length;
    }
    function MascaraCpfCnpjManual(campo){
        try {
            $(campo).unmask();
        } catch (e) {}

        var tamanho = $(campo).val().length;

        if(tamanho <= 11){
            $(campo).mask("999.999.999-99");
        } else {
            $(campo).mask("99.999.999/9999-99");
        }
    }
    function MascaraTelefone(campo){
        $(campo).unmask();
        $(campo)
        .mask("(99) 9999-99999")
        .focusout(function (event) {
            var target, phone, element;
            target = (event.currentTarget) ? event.currentTarget : event.srcElement;
            phone = target.value.replace(/\D/g, '');
            element = $(target);
            element.unmask();
            if(phone.length > 10) {
                element.mask("(99) 99999-9999");
            } else {
                element.mask("(99) 9999-99999");
            }
        });

    }
    function PopularEmpresas(campo, id = 0, Cnpj_Cnpf = 0, CdRepresentante = 0){
        var action = 'GetEmpresas';
        $(campo + ' option').remove();
        $.ajax({
            type: 'POST',
            url: 'dist/php/controllers/empresas.api.php',
            dataType: 'json',
            async: 'false',
            data: {'action': action, 'Cnpj_Cnpf': Cnpj_Cnpf, 'CdRepresentante':CdRepresentante},
            success: function (data)
            {
                console.log(data);
                $(data).each(function(k,v){

                    // console.log(v);
                    $(campo)
                       .append($("<option></option>")
                       .attr("value", v.id)
                       .attr("selected", v.ativo)
                       .text(v.nome));
                });



            }
        });


    }
    function BuscaCPFCNPJ(valor){
        // console.log(valor);
        var campo_empresas = "#cadastro_pedidos_edit_form_empresa";
        $(campo_empresas + ' option').remove();
        if(valor != ""){
            var action = 'valida';
            $.ajax({
                type: 'POST',
                url: 'dist/php/controllers/cpfcnpj.api.php',
                dataType: 'json',
                async: 'false',
                data: {'action': action, 'cpfcnpj':valor},
                success: function (data)
                {
                    console.log(data);
                    if(data.erro == 1){
                        toastr.error(data.resposta);
                    }
                    else {
                        toastr.success(data.resposta);
                        if(data.existe == 1){
                            $(data.dados.empresas).each(function(k,v){

                                // console.log(v);
                                $(campo_empresas)
                                   .append($("<option></option>")
                                   .attr("value", v.empresa)
                                   .attr("selected", v.ativo)
                                   .text(v.empresa_nome));
                            });
                            $('#cadastro_pedidos_edit_form_cliente_nome').val(data.dados.FsCliente);
                        }

                    }



                }
            });
        }
    }
    function CadastroPedidosIrParaProdutos(){
        if($('#cadastro_pedidos_edit_form_num_pedido_representante').val() == "" || $('#cadastro_pedidos_edit_form_num_pedido_representante').val() == "cadastro_pedidos_edit_form_num_pedido_compra"){
            // toastr.error('N° pedido repres e N° ped comp são obrigatórios');
            // return false;
        }
        $('#cadastro_pedidos_middle_form').hide();
        $('#cadastro_pedidos_produtos_form').show();
    }
    function CadastroPedidosContinuar(){
        var action = 'continuar';
        var cpfcnpj = $('#cadastro_pedidos_edit_form_cpfcnpj').val();
        var empresa = $('#cadastro_pedidos_edit_form_empresa').val();
        $.ajax({
            type: 'POST',
            url: 'content/pages/movimentacoes/pedidos/PedidosSistema/post.php',
            data: {'cpfcnpj': cpfcnpj, 'action': action, 'empresa':empresa},
            dataType: 'json',
            success: function (data)
            {
                console.log(data);
                if(data.erro == 1){
                    toastr.error('Erro: ' + data.mensagem);
                }
                else if(data.erro == 2){
                    console.log(data);
                    CarregaCadastroClientesPedidos();
                }
                else {
                    $('#cadastro_pedidos_edit_form_empresa_nome').val($('#cadastro_pedidos_edit_form_empresa :selected').text());
                    $('#cadastro_pedidos_edit_form_cliente_nome').val(data.dados.FsCliente);
                    $('#cadastro_pedidos_top_form').hide();
                    $('#cadastro_pedidos_middle_form').show();

                    GetTabelaPrecos(empresa, '#cadastro_pedidos_edit_form_tabela_preco');
                    GetCondPgto(empresa, '#cadastro_pedidos_edit_form_cond_pagto');
                    GetTransportadoras(empresa, '#cadastro_pedidos_edit_form_transportadora');
                    GetNaturezaOperacao(empresa, '#cadastro_pedidos_edit_form_natureza_operacao');
                }
            }
        });
    }
    function CarregaCadastroClientesPedidos(){
        var old_cnpj = $('#cadastro_pedidos_edit_form_cpfcnpj').val();
        toastr.warning('Cliente não encontrado, carregando tela para cadastramento.');
        $.ajax({
            type: 'POST',
            url: 'content/pages/cadastros/cadastros/CadastroClientes/cadastro_clientes.html',
            async: false,
            success: function (data)
            {
                $('#cadastro_clientes').html(data);
                $('#cadastro_pedidos_edit').hide();
                $('#cadastro_clientes').show();


            },
            complete: function(){
                console.log(old_cnpj);
                GetUserInfoEdit(0, 'novo');
                $('#cadastro_clientes_edit_form_cpfcnpj').val(old_cnpj);
                $('#post_screen').val('cadastro_pedidos');
                $('#cadastro_clientes_edit_form_empresa option[value=' + $('#cadastro_pedidos_edit_form_empresa').val() + ']').attr('selected',true);
            }
        });

    }
    function CadastroPedidosPosCliente(){
        $('#cadastro_clientes').html('');
        $('#cadastro_clientes').hide();
        $('#cadastro_pedidos_edit').show();
        CadastroPedidosContinuar();
    }
    function GetTabelaPrecos(empresa, campo){
        var action = 'get_tabelas_precos';
        // var empresa = $('#cadastro_pedidos_edit_form_empresa');
        $(campo + ' option').remove();
        $.ajax({
            type: 'POST',
            url: 'dist/php/controllers/sql_integration.api.php',
            dataType: 'json',
            async: 'false',
            data: {'action': action, 'empresa':empresa},
            success: function (data)
            {
                console.log(data);
                $(data).each(function(k,v){

                    // console.log(v);
                    $(campo)
                    .append($("<option></option>")
                    .attr("value", v.id_tabela)
                    .attr("selected", v.ativo)
                    .text(v.descricao_tabela));
                });



            }
        });
        //cadastro_pedidos_edit_form_tabela_preco
    }
    function GetCondPgto(empresa, campo){
        var action = 'get_cond_pagto';
        // var empresa = $('#cadastro_pedidos_edit_form_empresa');
        $(campo + ' option').remove();
        $.ajax({
            type: 'POST',
            url: 'dist/php/controllers/sql_integration.api.php',
            dataType: 'json',
            async: 'false',
            data: {'action': action, 'empresa':empresa},
            success: function (data)
            {
                console.log('condicoes de pagto');
                console.log(data);
                $(data).each(function(k,v){
                    if(v.minimo == null){
                        v.minimo = 0;
                    }
                    // console.log(v);
                    $(campo)
                    .append($("<option></option>")
                    .attr("value", v.id)
                    .attr("selected", v.ativo)
                    .text(v.descricao + ' / VALOR MINIMO: R$' + v.minimo));
                });



            }
        });
        //cadastro_pedidos_edit_form_tabela_preco
    }
    function GetTransportadoras(empresa, campo){
        var action = 'get_transportadoras';
        // var empresa = $('#cadastro_pedidos_edit_form_empresa');
        $(campo + ' option').remove();
        $.ajax({
            type: 'POST',
            url: 'dist/php/controllers/sql_integration.api.php',
            dataType: 'json',
            async: 'false',
            data: {'action': action, 'empresa':empresa},
            success: function (data)
            {
                console.log('transportadoras');
                console.log(data);
                $(data).each(function(k,v){

                    // console.log(v);
                    $(campo)
                    .append($("<option></option>")
                    .attr("value", v.id)
                    .attr("selected", v.ativo)
                    .text(v.descricao));
                });



            }
        });
        //cadastro_pedidos_edit_form_tabela_preco
    }
    function GetNaturezaOperacao(empresa, campo){
        var action = 'get_natureza_operacao';
        // var empresa = $('#cadastro_pedidos_edit_form_empresa');
        $(campo + ' option').remove();
        $.ajax({
            type: 'POST',
            url: 'dist/php/controllers/sql_integration.api.php',
            dataType: 'json',
            async: 'false',
            data: {'action': action, 'empresa':empresa},
            success: function (data)
            {
                console.log('condicoes de pagto');
                console.log(data);
                $(data).each(function(k,v){

                    // console.log(v);
                    $(campo)
                    .append($("<option></option>")
                    .attr("value", v.id)
                    .attr("selected", v.ativo)
                    .text(v.descricao));
                });



            }
        });
        //cadastro_pedidos_edit_form_tabela_preco
    }
    function BuscaCombo(element, busca, alvo = false){
        var tipo = "produto";
        if($('#busca_box').length){
            console.log('existe');
        }
        else {
            console.log('não existe, criando...');
            $('body').append('<div id="busca_box"></div>');
        }
        var left = $(element).offset().left;
        var top = $(element).offset().top;
        var altura = $(element).height();
        var largura = $(element).width();
        $('#busca_box').css('left', parseInt(left) + 'px');
        $('#busca_box').css('top', top+(altura*2) + 'px');
        $('#busca_box').css('width', largura + 'px');
        $('#busca_box').html('<span onclick="RemoveBuscaCombo();">buscando ' + busca + '...</span>');

        // var tabela_preco = $('#cadastro_pedidos_edit_form_tabela_preco');
        var tabela_preco = $('#cadastro_pedidos_edit_form_tabela_preco').val();
        if(busca != "" && tabela_preco != ""){
            var action = "busca_produtos";
            $.ajax({
                type: 'POST',
                url: 'dist/php/controllers/produtos.api.php',
                dataType: 'json',
                async: 'false',
                data: {'action': action, 'busca':busca, 'tabela':tabela_preco},
                success: function (data)
                {

                    console.log(data);
                    if(data['status'] == 'ok'){
                        var retorno = '';
                        var maximo = 5;
                        var cont = 1;
                        $(data['fetch']).each(function(k,v){
                            /* console.log(v); */
                            console.log(v.produto_id + 'Nome :' + v.produto_descricao);
                            if(cont<=maximo){
                                retorno = retorno + '<div class="busca_item" onclick="PreencheProduto(\'' + v.produto_id.trim() + '\', \'' + alvo + '\', \'' + v.produto_preco + '\', \'' + v.produto_descricao + '\');">' + v.produto_descricao + ' (' + v.produto_id + ') ' + v.produto_imagem + '</div>';
                            }
                            cont++;
                            /* console.log(k); */
                            /* var newvalue = JSON.parse(v);
                            console.log(newvalue); */
                        });
                        $('#busca_box').html(retorno);

                    }
                    if(data['status'] == 'erro'){
                        $('#busca_box').html('<span onclick="RemoveBuscaCombo();">Nenhum resultado para "' + busca + '" encontrado.</span>');
                    }

            }

        });
    }

}
    function RemoveBuscaCombo(){
        $('#busca_box').remove();
    }
    function PreencheProduto(valor, target, preco, nome){
    console.log('id:');
    console.log(valor);
    var elemento = target;
    // CarregaNome(elemento, valor, true);
    console.log(preco);
    preco = parseFloat(preco);
    $('#' + target + ' #vendas_nova_venda_produto_id').val(valor);
    $('#' + target + ' #vendas_nova_venda_produto_nome').val(nome);
    $('#' + target + ' #vendas_nova_venda_produto_valor').val( preco.toFixed(2) );
    $('#' + target + ' #vendas_nova_venda_produto_qt').focus();
    if($('#' + target + ' #vendas_nova_venda_produto_qt').val() == ''){
        $('#' + target + ' #vendas_nova_venda_produto_qt').val(1);
        $('#' + target + ' #vendas_nova_venda_produto_subtot').val( preco.toFixed(2) );
    }
    else {
        var qt = $('#' + target + ' #vendas_nova_venda_produto_qt').val();
        var subtot = qt*valor;
        $('#' + target + ' #vendas_nova_venda_produto_subtot').val( subtot.toFixed(2) );

    }

    RemoveBuscaCombo();
}
    function RecalculaValor(elemento, valor){
        if(valor != ''){
            var alvo = $(elemento).parent().parent();
            var classalvo = $(alvo).attr('id');
            if(valor <= 0){
                valor = 1;
                $('#' + classalvo + ' #vendas_nova_venda_produto_qt').val(1);
            }

            var qt = valor;
            var valor_original = $('#' + classalvo + ' #vendas_nova_venda_produto_valor').val();
            var valor_novo = valor_original*qt;
            $('#' + classalvo + ' #vendas_nova_venda_produto_subtot').val( valor_novo.toFixed(2) );
            CalculaTotal();
        }
    }
    function DeleteLinha(elemento){
        var alvo = $(elemento).parent().parent();
        var classalvo = $(alvo).attr('id');
        $('#' + classalvo + ' :input').val('');
        CalculaTotal();
    }
    function CalculaTotal(){
        var total = 0;
        $('.vendas_nova_venda_produto_subtot').each(function(k,v){
            var valor_aqui = $(v).val();
            if(valor_aqui != ''){
                total = Number(total)+Number(valor_aqui);
            }
        });
        $('#vendas_nova_venda_total').val(total.toFixed(2));

        $('#cadastro_pedidos_edit_form_cond_pagto option').each(function(k,v){
            var opcao = $(v).text();
            opcao = opcao.split("/ VALOR MINIMO: R$");
            valor = opcao[1];
            nome = opcao[0];
            valor = parseFloat(valor);
            total = parseFloat(total);
            if(valor > 0 && valor != "null"){
                if(total < valor){
                    $(this).attr("disabled", true);
                    $(this).attr("title", "Atinja R$ " + valor + " para habilitar esta opção");
                }
                else {
                    $(this).attr("disabled", false);
                    $(this).attr("title", "");
                }
            }
            else {
                    $(this).attr("disabled", false);
                    $(this).attr("title", "");
                }
        });
    }
    Date.prototype.toDateInputValue = (function() {
    var local = new Date(this);
    local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
    return local.toJSON().slice(0,10);
});
// function percent(z) {
//     v = z.value;
//     v = v.replace(/\D/g, "")  //permite digitar apenas números
//     v = v.replace(/\D(\d{,})/g, "")  //permite digitar apenas números
//     v = v.replace(/[0-9]{7}/, "inválido")   //limita pra máximo 999.999.999,99
//     v = v.replace(/(\d{1})(\d{1,2})$/, "$1.$2")        //coloca virgula antes dos ultimos 2 digitos
//     z.value = v;
// }

function percent(z){
    v = z.value;
    if(v.length == 1){
        v = v.replace(/\D/g, "");
    }
    if(v != ""){

        v = v.match(/^\d+\,?\d*/)[0];
        z.value = v;
    }
    else {
        z.value = v;
    }
}
</script>
<style type="text/css">
#busca_box {

    color: #FFF;
    position: absolute;
    left: 387px;
    top: 200px;
    z-index:1000;
    padding: 10px;
    border-radius: 10px;
    background-image: url('dist/img/background4.png');
}
#busca_box .busca_item {
    width: 100%;
    border: 1px solid #999;
    border-radius: 5px;
    padding: 5px;
    cursor:pointer;
    font-style:italic;
}
</style>
<style type="text/css">
    .pointer {
        cursor:pointer;
    }
    #cadastro_pedidos_edit_form label {
        font-weight: bold;
    }
        /* select option disabled {
        margin: 40px;
        background-color: #F00 !important;
        color: #fff;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.4);
    } */
    /* input, select, select option{background-color:#F00 !important} */
</style>
<script type="text/javascript" src="./assets/js/jquery.mask.min.js"></script>
<script type="text/javascript" src="./assets/scripts/main.87c0748b313a1dda75f5.js"></script>
