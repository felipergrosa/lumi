<div class="app-main__inner">

    <div id="cadastro_clientes" style="display:none">
    </div>

    <div class="mb-3 card" id="cadastro_pedidos_edit">
        <div class="card-header-tab card-header">
            <div class="card-header-title font-size-lg text-capitalize font-weight-normal" style="display:block;">
                <i class="header-icon lnr-charts icon-gradient bg-happy-green"> </i>
                <span>Cadastro de Pedido</span>
            </div>
        </div>
        <div class="card-body">
            <form onsubmit="return false;" id="cadastro_pedidos_edit_form" name="cadastro_pedidos_edit_form">
                <input type="hidden" name="action_for_form" id="action_for_form" value="" />
                <div class="form-group row">

                    <div class="col-md-8 col-xs-12">
                        <label for="cadastro_pedidos_edit_form_cpfcnpj">CPF/CNPJ</label>
                        <input type="text" class="form-control" id="cadastro_pedidos_edit_form_cpfcnpj" name="cadastro_pedidos_edit_form_cpfcnpj" onblur="BuscaCPFCNPJ(this.value);"/>
                    </div>

                    <div class="col-md-4 col-xs-12">
                        <label for="cadastro_pedidos_edit_form_empresa">Empresa</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_empresa" name="cadastro_pedidos_edit_form_empresa">
                        </select>
                    </div>

                </div>
                <button type="submit" class="btn btn-primary" onclick="CadastroPedidosContinuar();">Continuar</button>

                <div class="form-group row">
                    <div class="col-md-3 col-xs-4">
                        <input type="hidden" class="form-control" id="cadastro_pedidos_edit_form_id" name="cadastro_pedidos_edit_form_id" />
                        <label for="cadastro_pedidos_edit_form_empresa_nome">Empresa</label>
                        <input type="text" class="form-control" id="cadastro_pedidos_edit_form_empresa_nome" name="cadastro_pedidos_edit_form_empresa_nome" readonly/>
                    </div>
                    <div class="col-md-4 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_cliente_nome">Cliente</label>
                        <input type="text" class="form-control" id="cadastro_pedidos_edit_form_cliente_nome" name="cadastro_pedidos_edit_form_cliente_nome" readonly/>
                    </div>
                    <div class="col-md-1 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_prioridade">Prioridade</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_prioridade" name="cadastro_pedidos_edit_form_prioridade">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_frete">Frete</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_frete" name="cadastro_pedidos_edit_form_frete">
                            <option value="FOB">FOB</option>
                            <option value="CIF">CIF</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_num_pedido_representante">N° pedido repres.</label>
                        <input type="number" class="form-control" id="cadastro_pedidos_edit_form_num_pedido_representante" name="cadastro_pedidos_edit_form_num_pedido_representante" />
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_data_pedido">Data Pedido</label>
                        <input type="date" class="form-control" id="cadastro_pedidos_edit_form_data_pedido" name="cadastro_pedidos_edit_form_data_pedido" />
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_data_previsao_faturamento">Prev Fatura</label>
                        <input type="date" class="form-control" id="cadastro_pedidos_edit_form_data_previsao_faturamento" name="cadastro_pedidos_edit_form_data_previsao_faturamento" />
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_num_pedido_compra">N° ped comp</label>
                        <input type="number" class="form-control" id="cadastro_pedidos_edit_form_num_pedido_compra" name="cadastro_pedidos_edit_form_num_pedido_compra" />
                    </div>
                    <div class="col-md-3 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_tabela_preco">Tabela Preço</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_tabela_preco" name="cadastro_pedidos_edit_form_tabela_preco">
                            <option value="1">1</option>
                        </select>
                    </div>
                    <div class="col-md-3 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_cond_pagto">Cond. Pagto</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_cond_pagto" name="cadastro_pedidos_edit_form_cond_pagto">
                        </select>
                    </div>
                    <div class="col-md-3 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_transportadora">Transportadora</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_transportadora" name="cadastro_pedidos_edit_form_transportadora">
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-md-12"> <span class=" font-size-lg">Descontos</span> </div>

                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_desconto_padrao">Padrao</label>
                        <input type="number" step="any" class="form-control" id="cadastro_pedidos_edit_form_desconto_padrao" name="cadastro_pedidos_edit_form_desconto_padrao" />
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_desconto_adic1">Adic 1</label>
                        <input type="number" step="any" class="form-control" id="cadastro_pedidos_edit_form_desconto_adic1" name="cadastro_pedidos_edit_form_desconto_adic1" />
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_desconto_adic2">Adic 2</label>
                        <input type="number" step="any" class="form-control" id="cadastro_pedidos_edit_form_desconto_adic2" name="cadastro_pedidos_edit_form_desconto_adic2" />
                    </div>
                    <div class="col-md-2 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_desconto_adic3">Adic 3</label>
                        <input type="number" step="any" class="form-control" id="cadastro_pedidos_edit_form_desconto_adic3" name="cadastro_pedidos_edit_form_desconto_adic3" />
                    </div>
                    <div class="col-md-2 col-xs-4">
                        <label for="cadastro_pedidos_edit_form_desconto_part_com">Part.com.</label>
                        <input type="number" step="any" class="form-control" id="cadastro_pedidos_edit_form_desconto_part_com" name="cadastro_pedidos_edit_form_desconto_part_com" />
                    </div>
                    <div class="col-md-6 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_natureza_operacao">Natureza de operação</label>
                        <select class="form-control" id="cadastro_pedidos_edit_form_natureza_operacao" name="cadastro_pedidos_edit_form_natureza_operacao">
                        </select>
                    </div>
                    <div class="col-md-6 col-xs-2">
                        <label for="cadastro_pedidos_edit_form_observacao">Observação</label>
                        <textarea class="form-control" id="cadastro_pedidos_edit_form_observacao" name="cadastro_pedidos_edit_form_observacao"></textarea>
                    </div>

                </div>


                <button type="submit" class="btn btn-primary" onclick="CadastroPedidosSalvar();">Salvar</button>
            </form>
        </div>
    </div>

</div>


<script type="text/javascript">

    $(document).ready(function(){
        $.jMaskGlobals.watchDataMask = true;
        // window.onerror = function(){
        //    return true;
        // }
        MascaraCpfCnpj('#cadastro_pedidos_edit_form_cpfcnpj');


        PopularEmpresas('#cadastro_pedidos_edit_form_empresa');



    });

    function GetUserList(){
        $('.cadastro_pedidos_lista').html('');
        // console.log('getting');
        $.ajax({
            type: 'POST',
            url: 'content/pages/movimentacoes/pedidos/PedidosSistema/post.php',
            data: {'action':'GetUserList'},
            dataType: 'json',
            async: false,
            success: function (UserList)
            {
                $(UserList).each(function(k,v){
                    // console.log(UserList);

                    $('.cadastro_pedidos_lista').append('<tr onclick="GetUserInfoEdit(\'' + v.id + '\', \'editar\')"><td>' + v.nome + '</td><td class="campo_cpfcnpj_lista">' + v.cpfcnpj + '</td><td>' + v.endereco_cidade + '</td><td>' + v.endereco_estado + '</td></tr>');
                });
                MascaraCpfCnpjManualTexto('.campo_cpfcnpj_lista');
            }
        });
    }
    function GetUserInfoEdit(id, action){


    }

    function CadastroPedidosSalvar() {

        var dados = $('#cadastro_pedidos_edit_form').serializeArray();
        var empresas = $('#cadastro_pedidos_edit_form_empresa').val();
        var action = 'novo';

        // console.log(dados);
        $.ajax({
            type: 'POST',
            url: 'content/pages/movimentacoes/pedidos/PedidosSistema/post.php',
            data: {'dados': dados, 'action': action, 'empresas':empresas},
            success: function (data)
            {
                console.log(data);
                if (data == 0) {
                    toastr.success('Cadastro Realizado');

                } else {
                    toastr.error('Erro: ' + data);
                }
            }
        });

    }

    function MascaraCpfCnpj(campo){
        $(campo).keydown(function(event){
            // console.log(event.originalEvent.code);
            if(event.originalEvent.code != 'Tab' && event.originalEvent.code != 'Enter' && event.originalEvent.code != 'NumpadEnter'){
                try {
                    $(campo).unmask();
                } catch (e) {}

                var tamanho = $(campo).val().length;

                if(tamanho < 11){
                    $(campo).mask("999.999.999-99", {reverse: true, maxlength:false, recursive:true});
                } else {
                    $(campo).mask("99.999.999/9999-99", {reverse: true, maxlength:false, recursive:true});
                }

                // ajustando foco
                var elem = this;
                setTimeout(function(){
                    // mudo a posição do seletor
                    elem.selectionStart = elem.selectionEnd = 10000;
                }, 0);
                // reaplico o valor para mudar o foco
                var currentValue = $(this).val();
                $(this).val('');
                $(this).val(currentValue);
            }
        });

    }
    function MascaraCpfCnpjManualTexto(campo){
        try {
            $(campo).unmask();
        } catch (e) {}

        $(campo).each(function(k,v){
            var tamanho = $(v).text().length;
            if(tamanho <= 11){
                $(v).mask("999.999.999-99");
            } else {
                $(v).mask("99.999.999/9999-99");
            }
        });

        var tamanho = $(campo).text().length;
    }

    function MascaraCpfCnpjManual(campo){
        try {
            $(campo).unmask();
        } catch (e) {}

        var tamanho = $(campo).val().length;

        if(tamanho <= 11){
            $(campo).mask("999.999.999-99");
        } else {
            $(campo).mask("99.999.999/9999-99");
        }
    }

    function MascaraTelefone(campo){
        $(campo).unmask();
        $(campo)
        .mask("(99) 9999-99999")
        .focusout(function (event) {
            var target, phone, element;
            target = (event.currentTarget) ? event.currentTarget : event.srcElement;
            phone = target.value.replace(/\D/g, '');
            element = $(target);
            element.unmask();
            if(phone.length > 10) {
                element.mask("(99) 99999-9999");
            } else {
                element.mask("(99) 9999-99999");
            }
        });

    }




    function PopularEmpresas(campo, id = 0){
        var action = 'GetEmpresas';
        $(campo + ' option').remove();
        $.ajax({
            type: 'POST',
            url: 'dist/php/controllers/empresas.api.php',
            dataType: 'json',
            async: 'false',
            data: {'action': action, 'id':id},
            success: function (data)
            {
                console.log(data);
                $(data).each(function(k,v){

                    // console.log(v);
                    $(campo)
                    .append($("<option></option>")
                    .attr("value", v.id)
                    .attr("selected", v.ativo)
                    .text(v.nome));
                });



            }
        });

    }
    function BuscaCPFCNPJ(valor){
        // console.log(valor);
        var action = 'valida';
        $.ajax({
            type: 'POST',
            url: 'dist/php/controllers/cpfcnpj.api.php',
            dataType: 'json',
            async: 'false',
            data: {'action': action, 'cpfcnpj':valor},
            success: function (data)
            {
                // console.log(data);
                if(data.erro == 1){
                    toastr.error(data.resposta);
                }
                else {
                    toastr.success(data.resposta);
                }



            }
        });
    }

    function CadastroPedidosContinuar(){
        var action = 'continuar';
        var cpfcnpj = $('#cadastro_pedidos_edit_form_cpfcnpj').val();
        var empresa = $('#cadastro_pedidos_edit_form_empresa').val();
        $.ajax({
            type: 'POST',
            url: 'content/pages/movimentacoes/pedidos/PedidosSistema/post.php',
            data: {'cpfcnpj': cpfcnpj, 'action': action, 'empresa':empresa},
            dataType: 'json',
            success: function (data)
            {
                console.log(data);
                if(data.erro == 1){
                    toastr.error('Erro: ' + data.mensagem);
                }
                else if(data.erro == 2){
                    console.log(data);
                    CarregaCadastroClientesPedidos();
                }
                else {
                    $('#cadastro_pedidos_edit_form_empresa_nome').val(data.dados.empresa_nome);
                    $('#cadastro_pedidos_edit_form_cliente_nome').val(data.dados.cliente_nome);
                }
            }
        });
    }

    function CarregaCadastroClientesPedidos(){
        toastr.warning('Cliente não encontrado, carregando tela para cadastramento.');
        $.ajax({
            type: 'POST',
            url: 'content/pages/cadastros/cadastros/CadastroClientes/cadastro_clientes.html',
            async: false,
            success: function (data)
            {
                $('#cadastro_clientes').html(data);
                $('#cadastro_pedidos_edit').hide();
                $('#cadastro_clientes').show();


            },
            complete: function(){
                GetUserInfoEdit(0, 'novo');
                $('#cadastro_clientes_edit_form_cpfcnpj').val($('#cadastro_pedidos_edit_form_cpfcnpj').val());
                $('#post_screen').val('cadastro_pedidos');
                $('#cadastro_clientes_edit_form_empresa option[value=' + $('#cadastro_pedidos_edit_form_empresa').val() + ']').attr('selected',true);
            }
        });

    }

    function CadastroPedidosPosCliente(){
        $('#cadastro_clientes').html('');
        $('#cadastro_clientes').hide();
        $('#cadastro_pedidos_edit').show();
        CadastroPedidosContinuar();
    }

</script>
<style type="text/css">
    .pointer {
        cursor:pointer;
    }
    #cadastro_pedidos_edit_form label {
        font-weight: bold;
    }
</style>
<script type="text/javascript" src="./assets/js/jquery.mask.min.js"></script>
<script type="text/javascript" src="./assets/scripts/main.87c0748b313a1dda75f5.js"></script>
